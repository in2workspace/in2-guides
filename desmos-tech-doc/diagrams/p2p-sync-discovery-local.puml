@startuml
'https://plantuml.com/sequence-diagram

'---------- Config ----------------

autonumber

'---------- Header ----------------

boundary "External Access Node" as ean

box "Access Node"

  control "P2PDataSyncController" as p2pController
  participant "P2PDataSyncJob" as p2p_data_sync_job
  queue "ApplicationContext" as ac
  participant "Context Broker" as cb

end box

'---------- Diagram ----------------

ean -> p2pController++: POST /sync/p2p/discovery \nPayload: DiscoverySyncRequest

note right of ean
    DiscoverySyncRequest:

    {
        List<MvEntity4DataNegotiation> external_entity_ids ->
            id, type,
            version, lastUpdate
            hash, and hashlink(as previousHash)
        issuer
    }

    Hash is a SHA256 of the entity that is
    created by the External Access Node
    when the DiscoverySyncRequest is created.
end note

    p2pController -> p2p_data_sync_job++: dataDiscovery()
        p2p_data_sync_job -> cb++: GET /ngsi-ld/v1/entities\n  ?type=ProductOffering\n  &attrs=lastUpdate,version
        return 200 OK - Payload: List<EntityDTO>
        p2p_data_sync_job -> ac: PublishDataNegotiationEvent
    return List<EntityDTO>
return 200 OK - Payload: List<EntityDTO>

@enduml